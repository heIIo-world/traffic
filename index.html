<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="300">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,sans-serif;background:#1a1a2e;color:#fff;padding:15px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card{background:rgba(255,255,255,0.05);border-radius:12px;padding:15px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .route-name{font-weight:600;font-size:1.1em}
    .status{padding:4px 10px;border-radius:12px;font-size:.75em;font-weight:600;text-transform:uppercase}
    .status-clear{background:#22c55e;color:#000}
    .status-minor{background:#facc15;color:#000}
    .status-moderate{background:#f97316;color:#000}
    .status-major{background:#ef4444;color:#fff}
    .incident{padding:8px 0;border-top:1px solid rgba(255,255,255,0.1);font-size:.85em}
    .incident:first-child{border-top:none}
    .incident-type{color:#f97316;font-weight:500;font-size:.8em}
    .incident-desc{color:rgba(255,255,255,0.85);line-height:1.3;margin-top:3px}
    .clear-msg{color:rgba(255,255,255,0.5);font-style:italic}
    .footer{text-align:center;margin-top:15px;font-size:.75em;color:rgba(255,255,255,0.4)}
    .loading{text-align:center;padding:40px;color:rgba(255,255,255,0.5)}
  </style>
</head>
<body>
  <div id="content" class="loading">Loading traffic data...</div>
  <script>
    const API_KEY = '2633af7e-c608-4926-89df-3980024cb838';
    const ROUTES = [
      { name: 'US-101 South', keywords: ['101'] },
      { name: 'US-101 North', keywords: ['101'] },
      { name: 'I-280', keywords: ['280'] },
      { name: 'I-80 Bay Bridge', keywords: ['80'] },
      { name: 'CA-1', keywords: ['CA-1', 'Highway 1'] },
      { name: 'I-580', keywords: ['580'] },
      { name: 'I-880', keywords: ['880'] }
    ];

    async function load() {
      try {
        const res = await fetch(`https://api.511.org/traffic/events?api_key=${API_KEY}&format=json`);
        const text = await res.text();
        const data = JSON.parse(text.charCodeAt(0) === 65279 ? text.slice(1) : text);
        render(data.events || []);
      } catch(e) {
        document.getElementById('content').innerHTML = '<div class="loading">Error loading data</div>';
      }
    }

    function render(events) {
      let html = '<div class="grid">';
      ROUTES.forEach(route => {
        const matches = events.filter(e => 
          route.keywords.some(k => (e.headline||'').toUpperCase().includes(k.toUpperCase()))
        ).sort((a,b) => 
          ({'MAJOR':0,'MODERATE':1,'MINOR':2}[a.severity]||3) - ({'MAJOR':0,'MODERATE':1,'MINOR':2}[b.severity]||3)
        );
        
        let status = 'clear', statusText = 'Clear';
        if (matches.length) {
          const sev = matches[0].severity;
          if (sev==='MAJOR') { status='major'; statusText='Major'; }
          else if (sev==='MODERATE') { status='moderate'; statusText='Moderate'; }
          else { status='minor'; statusText='Minor'; }
        }
        
        html += `<div class="card"><div class="card-header">
          <span class="route-name">${route.name}</span>
          <span class="status status-${status}">${statusText}</span>
        </div>`;
        
        if (!matches.length) {
          html += '<div class="clear-msg">No incidents</div>';
        } else {
          matches.slice(0,3).forEach(m => {
            const type = {INCIDENT:'‚ö†Ô∏è',CONSTRUCTION:'üöß',WEATHER_CONDITION:'üåßÔ∏è'}[m.event_type]||'‚ö†Ô∏è';
            const desc = (m.headline||'').replace(/^CHP\s*:\s*/i,'').replace(/Expect delays\.?$/i,'');
            html += `<div class="incident"><span class="incident-type">${type}</span><div class="incident-desc">${desc}</div></div>`;
          });
          if (matches.length > 3) html += `<div class="incident" style="color:rgba(255,255,255,0.5)">+${matches.length-3} more</div>`;
        }
        html += '</div>';
      });
      html += `</div><div class="footer">Updated ${new Date().toLocaleTimeString()}</div>`;
      document.getElementById('content').innerHTML = html;
    }

    load();
  </script>
</body>
</html>
