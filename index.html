<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="300">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Kanit',sans-serif;background:#eae7e2;color:#333;padding:10px;height:100vh;overflow:hidden}
    .scroll-wrapper{height:100%;overflow:hidden}
    .scroll-container{display:flex;flex-direction:column;gap:8px;animation:scroll 45s linear infinite}
    .scroll-container:hover{animation-play-state:paused}
    .route{padding:8px 0;border-bottom:1px solid #d5d2cd}
    .route:last-child{border-bottom:none}
    .route-header{display:flex;justify-content:space-between;align-items:center}
    .route-name{font-weight:600;font-size:0.95em;color:#333}
    .status{font-size:.75em;font-weight:600}
    .status-clear{color:#5bb3b0}
    .status-minor{color:#c9a227}
    .status-moderate{color:#e07020}
    .status-major{color:#cc3333}
    .incidents{margin-top:4px}
    .incident{font-size:.8em;color:#555;line-height:1.4;margin-top:3px}
    .incident-type{color:#5bb3b0;margin-right:4px}
    .clear-msg{font-size:.8em;color:#888;font-style:italic}
    .loading{text-align:center;padding:20px;color:#888}
    @keyframes scroll{
      0%,10%{transform:translateY(0)}
      90%,100%{transform:translateY(-50%)}
    }
  </style>
</head>
<body>
  <div class="scroll-wrapper">
    <div id="content" class="loading">Loading...</div>
  </div>
  <script>
    const API_KEY = '2633af7e-c608-4926-89df-3980024cb838';
    const ROUTES = [
      { name: 'US-101 South', keywords: ['101'] },
      { name: 'US-101 North', keywords: ['101'] },
      { name: 'I-280', keywords: ['280'] },
      { name: 'I-80 Bay Bridge', keywords: ['80'] },
      { name: 'CA-1', keywords: ['CA-1', 'Highway 1'] },
      { name: 'I-580', keywords: ['580'] },
      { name: 'I-880', keywords: ['880'] }
    ];

    async function load() {
      try {
        const res = await fetch(`https://corsproxy.io/?https://api.511.org/traffic/events?api_key=${API_KEY}&format=json`);
        const text = await res.text();
        const data = JSON.parse(text.charCodeAt(0) === 65279 ? text.slice(1) : text);
        render(data.events || []);
      } catch(e) {
        document.getElementById('content').innerHTML = '<div class="loading">Error loading data</div>';
      }
    }

    function render(events) {
      let cards = '';
      ROUTES.forEach(route => {
        const matches = events.filter(e => 
          route.keywords.some(k => (e.headline||'').toUpperCase().includes(k.toUpperCase()))
        ).sort((a,b) => 
          ({'MAJOR':0,'MODERATE':1,'MINOR':2}[a.severity]||3) - ({'MAJOR':0,'MODERATE':1,'MINOR':2}[b.severity]||3)
        );
        
        let status = 'clear', statusText = 'No delays';
        if (matches.length) {
          const sev = matches[0].severity;
          if (sev==='MAJOR') { status='major'; statusText='Major delays'; }
          else if (sev==='MODERATE') { status='moderate'; statusText='Moderate delays'; }
          else { status='minor'; statusText='Minor delays'; }
        }
        
        cards += `<div class="route"><div class="route-header">
          <span class="route-name">${route.name}</span>
          <span class="status status-${status}">${statusText}</span>
        </div>`;
        
        if (matches.length) {
          cards += '<div class="incidents">';
          matches.slice(0,2).forEach(m => {
            const type = {INCIDENT:'‚ö†Ô∏è',CONSTRUCTION:'üöß',WEATHER_CONDITION:'üåßÔ∏è'}[m.event_type]||'‚ö†Ô∏è';
            const desc = (m.headline||'').replace(/^CHP\s*:\s*/i,'').replace(/Expect delays\.?$/i,'').substring(0,80);
            cards += `<div class="incident"><span class="incident-type">${type}</span>${desc}</div>`;
          });
          if (matches.length > 2) cards += `<div class="incident" style="color:#999">+${matches.length-2} more</div>`;
          cards += '</div>';
        }
        cards += '</div>';
      });
      
      document.getElementById('content').innerHTML = `<div class="scroll-container">${cards}${cards}</div>`;
    }

    load();
  </script>
</body>
</html>
